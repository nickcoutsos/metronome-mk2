<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="description" content="Bringin' the beats to the browsers.">
		<title>Metronome</title>
		<link rel="stylesheet" href="style.css" />
		<script src="puredom.light.js"></script>
		<script type="text/Javascript" src="metronome.js"></script>
		<script type="text/Javascript" src="touchslide-puredom.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	</head>
	<body>
		<div id="content">
			<div class="metronome">
				<div class="controls">
					<div class="button bpm-decrement">-</div>
					<div class="bpm-display">0</div>
					<div class="button bpm-increment">+</div>
				</div>
				<div class="beat">Additional settings pending further planning and development. Please stay tuned.</div>
				<div class="beat-counters">
					<div class="beat-counter beat-1 "></div>
					<div class="beat-counter beat-2"></div>
					<div class="beat-counter beat-3"></div>
					<div class="beat-counter beat-4"></div>
				</div>
			</div>
		</div>
	</body>
	
	<script type="text/Javascript">
		metronome = {};
		puredom(function(){
			var flash_length = 100;
			var start_bpm;
			var sfx = {
				down_beat: new Audio(),
				up_beat: new Audio()
			};
			
			sfx.down_beat.src = "down.wav";
			sfx.up_beat.src = "up.wav";
			
			metronome = new Metronome();
			
			// Input handlers
			puredom('.meter').addEvent('click', function(){metronome.toggle()});
			puredom('.beat').on('click', function() {metronome.toggle();});
			
			//
			// BPM Changers
			//
			
			// touch sliding
			puredom('.bpm-display').touchslide(0.85, 10)
			    .on('slidestart', function(e) { 
			        start_bpm = metronome.bpm;
			        puredom(this).classify('changing');
			    })
			    .on('sliding', function(e) {
			        metronome.set_bpm(Math.round(start_bpm + e.sourceOffsetX));
			    })
			    .on('slidestop', function(e) {
			        puredom(this).declassify('changing');
			    });
			
			// buttons
			puredom('.bpm-increment').addEvent('click', function(e){
			    metronome.increment()
			    puredom('.bpm-display')
			        .classify('changing')
                    .wait(200, function(){puredom('.bpm-display').declassify('changing')});
                
                return e.cancel();
		    });
			puredom('.bpm-decrement').addEvent('click', function(e){
			    metronome.decrement()
			    puredom('.bpm-display')
			        .classify('changing')
                    .wait(200, function(){puredom('.bpm-display').declassify('changing')});
                
                return e.cancel();
            });
            
            // keyboard arrows
			puredom(document).on('keyDown', function(e){
				var amount = 1;
				if (e.shiftKey) {
					amount = 10;
				}
				
				if (e.keyCode == 187 || e.keyCode == 39) {
					metronome.increment(amount);
				} else if (e.keyCode == 189 || e.keyCode == 37) {
					metronome.decrement(amount);
				} else if (e.keyCode == 32) {
					metronome.toggle();
				}
			});
			
			// scrolling
			puredom('.controls').on('mousewheel', function(e) {
				var amount = 1;
				if (e.shiftKey) {
					amount = 10;
				}
				if (Math.abs(e.wheelDeltaY) > Math.abs(e.wheelDeltaX)){ 
					if (e.wheelDeltaY > 0) {
						metronome.increment(amount);
					}
					else {
						metronome.decrement(amount);
					}
				}
			});
			
			//
			// Event handlers
			//
			
			// start
			metronome.on('start', function() {
				puredom('.beat, .beat-counter')
					.declassify('light')
					.declassify('flash');
			});
			
			// BPM increase/decrease
			metronome.on('bpmChange', function(bpm) {
				puredom('.bpm-display').text(bpm);
				
				// flash_length is just a nice visual effect that makes
				// the beat light flash for a duration dependant on the
				// length of the beat itself.
				//
				// = milliseconds per beat / 4, to a max of 100ms.
				flash_length = Math.min(100, (60 / bpm * 1000) * .1);
			});
			
			// time signature change
			metronome.on('meterChange', function(beats_per_measure) {
				
				var counters = puredom('.beat-counters');
				
				counters.children().remove();
				for (var i = 0; i < beats_per_measure; i++) {
					var beat = document.createElement('div');
					beat.className = 'beat-counter beat-' + (i+1) + ' ';
					counters.appendChild(beat);
				}
				
				// calculate widths
				var available = puredom('.beat-counters').width();
				var margins = 10 * (beats_per_measure);
				var counter = (available - margins) / beats_per_measure;
				
				puredom('.beat-counter').css({
					'width': counter + 'px',
					'margin': '0px 5px'
				});
				puredom('.beat-counter:first-child').css({
					'margin-left': '0px'
				});
				puredom('.beat-counter:last-child').css({
					'margin-right': '0px'
				})
			});
			
			metronome.on('fullBeat', function(beats, beat, measure){
				puredom('.beat-counter').declassify('light');
				puredom('.beat-' + beat)
					.classify('light', 'flash')
					.wait(flash_length, function(){
						this.declassify('flash');
					});
				
				if (beat == 1) {
					sfx.down_beat.currentTime = 0.0885;
					sfx.down_beat.play();
				}
				else {
					sfx.up_beat.currentTime = 0.0705;
					sfx.up_beat.play();
				}
			});
			
			metronome.on('measure', function(measure) {
				puredom('.beat-counter').declassify('light');
				if ((measure - 1) % 2 == 0) {
					metronome.increment(10);
					return false;
				}
			});
			
			metronome.init();
			metronome.set_bpm(80);
			metronome.set_meter(4);
			metronome._fireEvent('meterChange', 4);
		});
	</script>
</html>
